<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sıfır Atık Yarışması'na kayıt olun">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Security headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    
    <!-- Stylesheets -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
    
    <title>Kayıt Ol - Sıfır Atık Yarışması</title>
</head>
<body>
    <!-- Skip to main content -->
    <a href="#main-content" class="skip-link">Ana içeriğe geç</a>
    
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="/" class="logo-link">
                        <h1 class="logo-text">🌱 Sıfır Atık Yarışması</h1>
                    </a>
                </div>
                
                <nav class="header-nav">
                    <a href="/" class="nav-link">Ana Sayfa</a>
                    <a href="/admin.html" class="nav-link">Admin</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="main">
        <div class="container">
            <div class="registration-container">
                <div class="registration-card card">
                    <div class="card-header">
                        <h2 class="card-title">Yarışmaya Katıl</h2>
                        <p class="card-subtitle">
                            Sıfır atık bilginizi test etmeye hazır mısınız?
                        </p>
                    </div>
                    
                    <div class="card-body">
                        <!-- Registration Form -->
                        <form id="registration-form" class="registration-form" novalidate>
                            <!-- Name Field -->
                            <div class="form-group">
                                <label for="name" class="form-label">
                                    Ad Soyad <span class="required">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="name" 
                                    name="name" 
                                    class="form-input"
                                    required
                                    minlength="2"
                                    maxlength="50"
                                    autocomplete="name"
                                    aria-describedby="name-help name-error"
                                >
                                <div id="name-help" class="form-help">
                                    Gerçek adınızı girin (2-50 karakter)
                                </div>
                                <div id="name-error" class="form-error" role="alert"></div>
                            </div>

                            <!-- Email Field -->
                            <div class="form-group">
                                <label for="email" class="form-label">
                                    E-posta Adresi
                                </label>
                                <input 
                                    type="email" 
                                    id="email" 
                                    name="email" 
                                    class="form-input"
                                    autocomplete="email"
                                    aria-describedby="email-help email-error"
                                >
                                <div id="email-help" class="form-help">
                                    İsteğe bağlı - Sonuçlarınız için bilgilendirme
                                </div>
                                <div id="email-error" class="form-error" role="alert"></div>
                            </div>

                            <!-- Phone Field -->
                            <div class="form-group">
                                <label for="phone" class="form-label">
                                    Telefon Numarası
                                </label>
                                <input 
                                    type="tel" 
                                    id="phone" 
                                    name="phone" 
                                    class="form-input"
                                    placeholder="5XX XXX XX XX"
                                    autocomplete="tel"
                                    aria-describedby="phone-help phone-error"
                                >
                                <div id="phone-help" class="form-help">
                                    İsteğe bağlı - Türk telefon numarası formatında
                                </div>
                                <div id="phone-error" class="form-error" role="alert"></div>
                            </div>

                            <!-- Consent Fields -->
                            <div class="form-group">
                                <div class="consent-group">
                                    <div class="consent-item">
                                        <label class="consent-label">
                                            <input 
                                                type="checkbox" 
                                                id="consent-terms" 
                                                name="consentTerms" 
                                                class="form-checkbox"
                                                required
                                                aria-describedby="consent-terms-error"
                                            >
                                            <span class="consent-text">
                                                <strong>Kullanım Koşulları</strong> ve <strong>Gizlilik Politikası</strong>'nı okudum ve kabul ediyorum <span class="required">*</span>
                                            </span>
                                        </label>
                                        <div id="consent-terms-error" class="form-error" role="alert"></div>
                                    </div>

                                    <div class="consent-item">
                                        <label class="consent-label">
                                            <input 
                                                type="checkbox" 
                                                id="consent-marketing" 
                                                name="consentMarketing" 
                                                class="form-checkbox"
                                            >
                                            <span class="consent-text">
                                                Pazarlama iletişimi almayı kabul ediyorum
                                            </span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- KVKK Information -->
                            <div class="kvkk-info">
                                <h3 class="kvkk-title">🛡️ Veri Gizliliği</h3>
                                <ul class="kvkk-list">
                                    <li>Ses verileriniz <strong>saklanmaz</strong>, sadece metin dökümleri geçici tutulur</li>
                                    <li>Kişisel bilgileriniz KVKK kapsamında korunur</li>
                                    <li>Yarışma verileri maksimum 1 yıl saklanır</li>
                                    <li>Dilediğiniz zaman verilerinizi silebilirsiniz</li>
                                </ul>
                            </div>

                            <!-- Submit Button -->
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                                    <span class="btn-text">Kayıt Ol ve Başla</span>
                                    <span class="btn-loading loading" style="display: none;"></span>
                                </button>
                                
                                <a href="/" class="btn btn-outline">
                                    Ana Sayfaya Dön
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Success Message -->
                <div id="success-message" class="success-card card" style="display: none;">
                    <div class="card-body">
                        <div class="success-content">
                            <div class="success-icon">✅</div>
                            <h3 class="success-title">Kayıt Başarılı!</h3>
                            <p class="success-description">
                                Yarışmaya katılım için hazırsınız. Şimdi yarışma sayfasına yönlendiriliyorsunuz...
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script type="module">
        import { api, apiClient, APIClientError } from '/js/core/ApiClient.ts';

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('registration-form');
            const submitBtn = document.getElementById('submit-btn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');
            const successMessage = document.getElementById('success-message');

            // Form validation
            const validators = {
                name: (value) => {
                    if (!value || value.trim().length < 2) {
                        return 'İsim en az 2 karakter olmalıdır';
                    }
                    if (value.length > 50) {
                        return 'İsim en fazla 50 karakter olabilir';
                    }
                    if (!/^[a-zA-ZğüşıöçĞÜŞİÖÇ\s]+$/.test(value)) {
                        return 'İsim sadece harf içerebilir';
                    }
                    return null;
                },
                
                email: (value) => {
                    if (!value) return null; // Optional field
                    
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(value)) {
                        return 'Geçerli bir e-posta adresi giriniz';
                    }
                    return null;
                },
                
                phone: (value) => {
                    if (!value) return null; // Optional field
                    
                    const phoneRegex = /^(\+90|0)?[5][0-9]{9}$/;
                    const cleanPhone = value.replace(/\s/g, '');
                    if (!phoneRegex.test(cleanPhone)) {
                        return 'Geçerli bir telefon numarası giriniz (5XX XXX XX XX)';
                    }
                    return null;
                },
                
                consentTerms: (checked) => {
                    if (!checked) {
                        return 'Kullanım koşullarını kabul etmelisiniz';
                    }
                    return null;
                }
            };

            // Real-time validation
            Object.keys(validators).forEach(fieldName => {
                const field = form.querySelector(`[name="${fieldName}"]`);
                const errorElement = document.getElementById(`${fieldName.replace(/([A-Z])/g, '-$1').toLowerCase()}-error`);
                
                if (field && errorElement) {
                    field.addEventListener('blur', () => {
                        const value = field.type === 'checkbox' ? field.checked : field.value;
                        const error = validators[fieldName](value);
                        
                        if (error) {
                            field.classList.add('error');
                            errorElement.textContent = error;
                        } else {
                            field.classList.remove('error');
                            errorElement.textContent = '';
                        }
                    });
                }
            });

            // Form submission
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Validate all fields
                let hasErrors = false;
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                // Add checkbox values
                data.consentTerms = form.querySelector('[name="consentTerms"]').checked;
                data.consentMarketing = form.querySelector('[name="consentMarketing"]').checked;
                
                // Validate all fields
                Object.keys(validators).forEach(fieldName => {
                    const value = data[fieldName];
                    const error = validators[fieldName](value);
                    const field = form.querySelector(`[name="${fieldName}"]`);
                    const errorElement = document.getElementById(`${fieldName.replace(/([A-Z])/g, '-$1').toLowerCase()}-error`);
                    
                    if (error) {
                        hasErrors = true;
                        if (field) field.classList.add('error');
                        if (errorElement) errorElement.textContent = error;
                    } else {
                        if (field) field.classList.remove('error');
                        if (errorElement) errorElement.textContent = '';
                    }
                });

                if (hasErrors) {
                    return;
                }

                // Show loading state
                submitBtn.disabled = true;
                btnText.style.display = 'none';
                btnLoading.style.display = 'inline-block';

                try {
                    // Register user
                    const response = await api.auth.register({
                        name: data.name.trim(),
                        email: data.email ? data.email.trim() : undefined,
                        phone: data.phone ? data.phone.trim() : undefined,
                        consentMarketing: data.consentMarketing,
                        consentTerms: data.consentTerms,
                    });

                    if (response.success && response.data) {
                        // Store auth token
                        apiClient.setAuthToken(response.data.token);
                        
                        // Show success message
                        form.style.display = 'none';
                        successMessage.style.display = 'block';
                        
                        // Redirect to quiz page
                        setTimeout(() => {
                            window.location.href = '/quiz.html';
                        }, 2000);
                    }
                    
                } catch (error) {
                    console.error('Registration failed:', error);
                    
                    let errorMessage = 'Kayıt işlemi başarısız oldu. Lütfen tekrar deneyin.';
                    
                    if (error instanceof APIClientError) {
                        errorMessage = error.message;
                        
                        // Handle specific error cases
                        if (error.code === 'PARTICIPANT_EXISTS') {
                            const emailField = form.querySelector('[name="email"]');
                            const phoneField = form.querySelector('[name="phone"]');
                            
                            if (emailField && data.email) {
                                emailField.classList.add('error');
                                document.getElementById('email-error').textContent = 'Bu e-posta adresi zaten kullanımda';
                            }
                            if (phoneField && data.phone) {
                                phoneField.classList.add('error');
                                document.getElementById('phone-error').textContent = 'Bu telefon numarası zaten kullanımda';
                            }
                        }
                    }
                    
                    showErrorMessage(errorMessage);
                    
                } finally {
                    // Hide loading state
                    submitBtn.disabled = false;
                    btnText.style.display = 'inline';
                    btnLoading.style.display = 'none';
                }
            });

            function showErrorMessage(message) {
                // Create or update error alert
                let errorAlert = document.getElementById('error-alert');
                
                if (!errorAlert) {
                    errorAlert = document.createElement('div');
                    errorAlert.id = 'error-alert';
                    errorAlert.className = 'error-alert';
                    errorAlert.setAttribute('role', 'alert');
                    form.insertBefore(errorAlert, form.firstChild);
                }
                
                errorAlert.innerHTML = `
                    <div class="alert-content">
                        <span class="alert-icon">⚠️</span>
                        <span class="alert-message">${message}</span>
                        <button type="button" class="alert-close" onclick="this.parentElement.parentElement.remove()">×</button>
                    </div>
                `;
                
                errorAlert.style.display = 'block';
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    if (errorAlert && errorAlert.parentElement) {
                        errorAlert.remove();
                    }
                }, 5000);
            }
        });
    </script>
    
    <style>
        /* Page-specific styles */
        .header {
            background-color: var(--color-surface);
            border-bottom: 1px solid var(--color-outline);
            padding: var(--space-4) 0;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: var(--space-4);
        }
        
        .logo-link {
            text-decoration: none;
            color: inherit;
        }
        
        .logo-text {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            margin: 0;
        }
        
        .header-nav {
            display: flex;
            gap: var(--space-4);
        }
        
        .nav-link {
            font-weight: var(--font-weight-medium);
        }
        
        .main {
            padding: var(--space-12) 0;
            background: linear-gradient(135deg, var(--color-primary-50), var(--color-secondary-50));
            min-height: calc(100vh - 200px);
        }
        
        .registration-container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .registration-card {
            margin-bottom: var(--space-8);
        }
        
        .card-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--space-2);
            text-align: center;
        }
        
        .card-subtitle {
            color: var(--color-text-secondary);
            text-align: center;
            margin-bottom: 0;
        }
        
        .registration-form {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .required {
            color: var(--color-error);
        }
        
        .consent-group {
            border: 1px solid var(--color-outline);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            background-color: var(--color-surface-variant);
        }
        
        .consent-item {
            margin-bottom: var(--space-3);
        }
        
        .consent-item:last-child {
            margin-bottom: 0;
        }
        
        .consent-label {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            cursor: pointer;
            line-height: 1.4;
        }
        
        .consent-text {
            font-size: var(--font-size-sm);
        }
        
        .kvkk-info {
            background-color: var(--color-info);
            color: white;
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-6);
        }
        
        .kvkk-title {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-3);
            color: white;
        }
        
        .kvkk-list {
            font-size: var(--font-size-sm);
            padding-left: var(--space-4);
            margin: 0;
        }
        
        .kvkk-list li {
            margin-bottom: var(--space-2);
        }
        
        .form-actions {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        
        .btn-lg {
            padding: var(--space-4) var(--space-8);
            font-size: var(--font-size-lg);
        }
        
        .btn-loading {
            margin-right: var(--space-2);
        }
        
        .success-card {
            background-color: var(--color-success);
            color: white;
            text-align: center;
        }
        
        .success-content {
            padding: var(--space-8);
        }
        
        .success-icon {
            font-size: var(--font-size-4xl);
            margin-bottom: var(--space-4);
        }
        
        .success-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--space-4);
            color: white;
        }
        
        .success-description {
            font-size: var(--font-size-lg);
            color: white;
            opacity: 0.9;
        }
        
        .error-alert {
            background-color: var(--color-error);
            color: white;
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-6);
            display: none;
        }
        
        .alert-content {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .alert-icon {
            flex-shrink: 0;
        }
        
        .alert-message {
            flex: 1;
        }
        
        .alert-close {
            background: none;
            border: none;
            color: white;
            font-size: var(--font-size-lg);
            cursor: pointer;
            padding: var(--space-1);
            border-radius: var(--radius-sm);
            transition: background-color var(--duration-150) var(--ease-in-out);
        }
        
        .alert-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .main {
                padding: var(--space-6) 0;
            }
            
            .registration-container {
                padding: 0 var(--space-4);
            }
            
            .header-content {
                text-align: center;
            }
            
            .form-actions {
                gap: var(--space-4);
            }
        }
    </style>
</body>
</html>
